--// âš™ï¸ Cáº¥u hÃ¬nh
local PLAYER_LIMIT = 5 -- sá»‘ lÆ°á»£ng ngÆ°á»i chÆ¡i tá»‘i Ä‘a trong server
local CHECK_INTERVAL = 15 -- giÃ¢y giá»¯a má»—i láº§n kiá»ƒm tra

--// ğŸ“ Blacklist server
local bM = {}
local HttpService = game:GetService("HttpService")
local bN = "!Blacklist_Servers.json"
function Saveserver()
    writefile(bN, HttpService:JSONEncode(bM))
end
function ReadServer()
    local success, result = pcall(function()
        return HttpService:JSONDecode(readfile(bN))
    end)
    if success then
        return result
    else
        Saveserver()
        return {}
    end
end
bM = ReadServer()

--// ğŸŒ• Kiá»ƒm tra full moon
function IsFullMoon()
    local Lighting = game:GetService("Lighting")
    if Lighting:GetAttribute("FullMoon") ~= nil then
        return Lighting:GetAttribute("FullMoon") == true
    end

    local moonModel = Lighting:FindFirstChild("Moon")
    if moonModel and moonModel:FindFirstChild("Moon") then
        local moonPart = moonModel.Moon
        return moonPart.Size.Magnitude >= 17 -- hoáº·c chá»‰nh náº¿u sai
    end

    return false
end

--// ğŸ‘¥ Kiá»ƒm tra sá»‘ ngÆ°á»i hiá»‡n táº¡i
function IsServerCrowded(threshold)
    return #game.Players:GetPlayers() > threshold
end

--// ğŸšª Hop server tá»« danh sÃ¡ch
function HopServer()
    for r = 1, 500 do
        local servers = game:GetService("ReplicatedStorage").__ServerBrowser:InvokeServer(r)
        if servers then
            for k, v in pairs(servers) do
                if
                    k ~= game.JobId and
                    v["Count"] <= PLAYER_LIMIT and
                    (not bM[k] or tick() - bM[k].Time > 60 * 10)
                then
                    bM[k] = { Time = tick() }
                    Saveserver()
                    print("[HOP] ğŸŸ¢ Äang chuyá»ƒn Ä‘áº¿n server:", k, " (", v["Count"], "players)")
                    game:GetService("ReplicatedStorage").__ServerBrowser:InvokeServer("teleport", k)
                    return true
                elseif tick() - bM[k].Time > 60 * 60 then
                    bM[k] = nil
                end
            end
        end
        if r % 100 == 0 then task.wait() end
    end
    return false
end

--// ğŸ§  VÃ²ng kiá»ƒm tra Ä‘á»‹nh ká»³
spawn(function()
    while task.wait(CHECK_INTERVAL) do
        local isCrowded = IsServerCrowded(PLAYER_LIMIT)
        local isFullMoon = IsFullMoon()

        print("[CHECK] ğŸ‘¥ NgÆ°á»i chÆ¡i:", #game.Players:GetPlayers(), " | ğŸŒ• Full moon:", isFullMoon)

        if not isFullMoon or isCrowded then
            warn("[HOP] ğŸ”„ KhÃ´ng há»£p lá»‡ (fullmoon =", isFullMoon, ", crowded =", isCrowded, ") â†’ Hop")
            HopServer()
        else
            print("[OK] âœ… Server á»•n Ä‘á»‹nh. KhÃ´ng cáº§n hop.")
        end
    end
end)
